<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arkansas Public Finance Dashboard ‚Äî NAMI Arkansas</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3"></script>
    <style>
        :root {
            --nami-blue: #00467f;
            --nami-green: #7ab800;
            --nami-light: #e8f4f8;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            min-height: 100vh;
            color: #333;
        }
        
        header {
            background: var(--nami-blue);
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        header h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        header .subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 4px;
        }
        
        .logo-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .nami-badge {
            background: var(--nami-green);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }
        
        .stat-card .number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--nami-blue);
        }
        
        .stat-card .label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 8px;
        }
        
        .stat-card.highlight {
            background: var(--nami-blue);
            color: white;
        }
        
        .stat-card.highlight .number {
            color: var(--nami-green);
        }
        
        .stat-card.highlight .label {
            color: rgba(255,255,255,0.8);
        }
        
        /* Section Cards */
        .section-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
        }
        
        .section-card h2 {
            font-size: 1.3rem;
            color: var(--nami-blue);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-card h2 .icon {
            font-size: 1.5rem;
        }
        
        /* Sankey Diagram */
        #sankey-container {
            width: 100%;
            overflow-x: auto;
        }
        
        #sankey-chart {
            min-width: 900px;
        }
        
        .sankey-node rect {
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .sankey-node rect:hover {
            opacity: 0.8;
        }
        
        .sankey-node text {
            font-size: 11px;
            font-weight: 500;
            fill: #333;
        }
        
        .sankey-link {
            fill: none;
            stroke-opacity: 0.4;
            transition: stroke-opacity 0.2s;
        }
        
        .sankey-link:hover {
            stroke-opacity: 0.7;
        }
        
        /* Flow Table */
        .flow-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .flow-table th {
            background: var(--nami-light);
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--nami-blue);
            border-bottom: 2px solid var(--nami-blue);
        }
        
        .flow-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
        }
        
        .flow-table tr:hover {
            background: #f9f9f9;
        }
        
        .amount {
            font-weight: 600;
            color: var(--nami-green);
        }
        
        .amount.zero {
            color: #999;
            font-style: italic;
        }
        
        .fund-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .fund-badge.federal { background: #e3f2fd; color: #1565c0; }
        .fund-badge.state { background: #e8f5e9; color: #2e7d32; }
        .fund-badge.settlement { background: #fff3e0; color: #e65100; }
        
        /* Authority List */
        .authority-list {
            display: grid;
            gap: 15px;
        }
        
        .authority-item {
            border-left: 4px solid var(--nami-green);
            padding: 15px 20px;
            background: var(--nami-light);
            border-radius: 0 8px 8px 0;
        }
        
        .authority-item .citation {
            font-weight: 600;
            color: var(--nami-blue);
            font-size: 1rem;
        }
        
        .authority-item .body {
            font-size: 0.85rem;
            color: #666;
            margin-top: 4px;
        }
        
        .authority-item .governs {
            font-size: 0.85rem;
            color: #444;
            margin-top: 8px;
        }
        
        /* Tabs */
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.95rem;
            color: #666;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s;
        }
        
        .tab-btn:hover {
            background: var(--nami-light);
        }
        
        .tab-btn.active {
            background: var(--nami-blue);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 0.85rem;
            pointer-events: none;
            z-index: 1000;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .tooltip .title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 30px;
            color: #666;
            font-size: 0.85rem;
        }
        
        footer a {
            color: var(--nami-blue);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .container {
                padding: 15px;
            }
            
            .section-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>Arkansas Public Finance Dashboard</h1>
            <div class="subtitle">Operation NAMI Clearlane ‚Äî Validated Artifacts</div>
        </div>
        <div class="logo-area">
            <span class="nami-badge">NAMI Arkansas</span>
        </div>
    </header>
    
    <div class="container">
        <!-- Stats Cards -->
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card highlight">
                <div class="number" id="total-flows">‚Äî</div>
                <div class="label">Money Flows</div>
            </div>
            <div class="stat-card">
                <div class="number" id="total-authorities">‚Äî</div>
                <div class="label">Legal Authorities</div>
            </div>
            <div class="stat-card">
                <div class="number" id="total-evidence">‚Äî</div>
                <div class="label">Evidence Items</div>
            </div>
            <div class="stat-card">
                <div class="number" id="total-amount">‚Äî</div>
                <div class="label">Total Tracked (FY26)</div>
            </div>
        </div>
        
        <!-- Money Flow Sankey -->
        <div class="section-card">
            <h2><span class="icon">üí∞</span> Money Flow Visualization</h2>
            <p style="color:#666; margin-bottom:20px; font-size:0.9rem;">
                This diagram shows how funds flow from sources through intermediaries to destinations. 
                Wider bands represent larger amounts. Hover for details.
            </p>
            <div id="sankey-container">
                <svg id="sankey-chart"></svg>
            </div>
        </div>
        
        <!-- Tabbed Content -->
        <div class="section-card">
            <div class="tab-container">
                <button class="tab-btn active" data-tab="flows">Money Flows</button>
                <button class="tab-btn" data-tab="authorities">Legal Authorities</button>
                <button class="tab-btn" data-tab="validations">Audit Findings</button>
            </div>
            
            <div id="flows" class="tab-content active">
                <table class="flow-table">
                    <thead>
                        <tr>
                            <th>Source</th>
                            <th>Destination</th>
                            <th>Amount</th>
                            <th>Fund Type</th>
                            <th>Fiscal Year</th>
                        </tr>
                    </thead>
                    <tbody id="flow-table-body">
                    </tbody>
                </table>
            </div>
            
            <div id="authorities" class="tab-content">
                <div class="authority-list" id="authority-list">
                </div>
            </div>
            
            <div id="validations" class="tab-content">
                <div class="authority-list" id="validation-list">
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        Generated from <a href="graph_viewer.html">Artifact Graph</a> | 
        Data validated as of <span id="data-date">‚Äî</span>
    </footer>
    
    <div class="tooltip" id="tooltip" style="display:none;"></div>

    <script>
        // Load artifact graph data
        let graphData = null;
        
        async function loadData() {
            try {
                const response = await fetch('artifacts_graph.json');
                graphData = await response.json();
                renderDashboard();
            } catch (err) {
                console.error('Failed to load data:', err);
                document.querySelector('.container').innerHTML = `
                    <div class="section-card" style="text-align:center; color:#c00;">
                        <h2>‚ö†Ô∏è Data Not Found</h2>
                        <p>Run <code>python scripts/linkage_analyzer.py --export-json</code> to generate the data file.</p>
                    </div>
                `;
            }
        }
        
        function renderDashboard() {
            const nodes = graphData.nodes;
            
            // Categorize nodes
            const flows = nodes.filter(n => n.category === 'money_flow');
            const authorities = nodes.filter(n => n.category === 'authority_reference');
            const evidence = nodes.filter(n => n.category === 'evidence_item');
            const validations = nodes.filter(n => n.category === 'field_validation');
            
            // Calculate total amount (only FY2026 flows with amounts)
            const totalAmount = flows
                .filter(f => f.data?.fiscal_year?.includes('2026') && f.data?.amount > 0)
                .reduce((sum, f) => sum + (f.data?.amount || 0), 0);
            
            // Update stats
            document.getElementById('total-flows').textContent = flows.length;
            document.getElementById('total-authorities').textContent = authorities.length;
            document.getElementById('total-evidence').textContent = evidence.length;
            document.getElementById('total-amount').textContent = '$' + totalAmount.toLocaleString();
            document.getElementById('data-date').textContent = new Date().toLocaleDateString();
            
            // Render components
            renderSankey(flows);
            renderFlowTable(flows);
            renderAuthorityList(authorities);
            renderValidationList(validations);
            
            // Setup tabs
            setupTabs();
        }
        
        function renderSankey(flows) {
            // Filter flows with meaningful connections
            const validFlows = flows.filter(f => 
                f.data?.source && f.data?.destination && 
                f.data.source !== 'Unknown' && f.data.destination !== 'Unknown'
            );
            
            if (validFlows.length === 0) {
                document.getElementById('sankey-container').innerHTML = '<p style="color:#666;">No flow data available for visualization.</p>';
                return;
            }
            
            // Build unique nodes
            const nodeNames = new Set();
            validFlows.forEach(f => {
                nodeNames.add(f.data.source);
                if (f.data.intermediary && f.data.intermediary !== 'None') {
                    nodeNames.add(f.data.intermediary);
                }
                nodeNames.add(f.data.destination);
            });
            
            const sankeyNodes = Array.from(nodeNames).map(name => ({ name }));
            const nodeIndex = {};
            sankeyNodes.forEach((n, i) => nodeIndex[n.name] = i);
            
            // Build links
            const sankeyLinks = [];
            validFlows.forEach(f => {
                const amount = f.data.amount || 100000; // Default for visualization
                const fundType = f.data.fund_type || 'state';
                
                if (f.data.intermediary && f.data.intermediary !== 'None') {
                    // Two-step flow
                    sankeyLinks.push({
                        source: nodeIndex[f.data.source],
                        target: nodeIndex[f.data.intermediary],
                        value: amount,
                        fundType: fundType,
                        flowId: f.id
                    });
                    sankeyLinks.push({
                        source: nodeIndex[f.data.intermediary],
                        target: nodeIndex[f.data.destination],
                        value: amount,
                        fundType: fundType,
                        flowId: f.id
                    });
                } else {
                    // Direct flow
                    sankeyLinks.push({
                        source: nodeIndex[f.data.source],
                        target: nodeIndex[f.data.destination],
                        value: amount,
                        fundType: fundType,
                        flowId: f.id
                    });
                }
            });
            
            // Setup SVG
            const width = 900;
            const height = 500;
            const margin = { top: 20, right: 150, bottom: 20, left: 150 };
            
            const svg = d3.select('#sankey-chart')
                .attr('width', width)
                .attr('height', height);
            
            svg.selectAll('*').remove();
            
            // Create sankey generator
            const sankey = d3.sankey()
                .nodeWidth(20)
                .nodePadding(15)
                .extent([[margin.left, margin.top], [width - margin.right, height - margin.bottom]]);
            
            // Generate layout
            const { nodes: layoutNodes, links: layoutLinks } = sankey({
                nodes: sankeyNodes.map(d => Object.assign({}, d)),
                links: sankeyLinks.map(d => Object.assign({}, d))
            });
            
            // Color scale for fund types
            const colorScale = {
                'federal': '#1565c0',
                'state': '#2e7d32',
                'settlement': '#e65100'
            };
            
            // Draw links
            svg.append('g')
                .selectAll('.sankey-link')
                .data(layoutLinks)
                .join('path')
                .attr('class', 'sankey-link')
                .attr('d', d3.sankeyLinkHorizontal())
                .attr('stroke', d => colorScale[d.fundType] || '#888')
                .attr('stroke-width', d => Math.max(1, d.width))
                .on('mouseover', showLinkTooltip)
                .on('mouseout', hideTooltip);
            
            // Draw nodes
            const nodeGroup = svg.append('g')
                .selectAll('.sankey-node')
                .data(layoutNodes)
                .join('g')
                .attr('class', 'sankey-node')
                .attr('transform', d => `translate(${d.x0},${d.y0})`);
            
            nodeGroup.append('rect')
                .attr('height', d => d.y1 - d.y0)
                .attr('width', d => d.x1 - d.x0)
                .attr('fill', '#00467f')
                .on('mouseover', showNodeTooltip)
                .on('mouseout', hideTooltip);
            
            nodeGroup.append('text')
                .attr('x', d => d.x0 < width / 2 ? -6 : (d.x1 - d.x0) + 6)
                .attr('y', d => (d.y1 - d.y0) / 2)
                .attr('dy', '0.35em')
                .attr('text-anchor', d => d.x0 < width / 2 ? 'end' : 'start')
                .text(d => truncate(d.name, 30));
        }
        
        function truncate(str, len) {
            return str.length > len ? str.slice(0, len) + '‚Ä¶' : str;
        }
        
        function showLinkTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <div class="title">${d.source.name} ‚Üí ${d.target.name}</div>
                <div>Amount: $${d.value.toLocaleString()}</div>
                <div>Fund Type: ${d.fundType}</div>
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
        }
        
        function showNodeTooltip(event, d) {
            const inflow = d.targetLinks.reduce((sum, l) => sum + l.value, 0);
            const outflow = d.sourceLinks.reduce((sum, l) => sum + l.value, 0);
            
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <div class="title">${d.name}</div>
                ${inflow > 0 ? `<div>Inflow: $${inflow.toLocaleString()}</div>` : ''}
                ${outflow > 0 ? `<div>Outflow: $${outflow.toLocaleString()}</div>` : ''}
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
        }
        
        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }
        
        function renderFlowTable(flows) {
            const tbody = document.getElementById('flow-table-body');
            tbody.innerHTML = flows
                .sort((a, b) => (b.data?.amount || 0) - (a.data?.amount || 0))
                .map(f => {
                    const d = f.data || {};
                    const amountClass = d.amount === 0 ? 'amount zero' : 'amount';
                    const amountText = d.amount === 0 ? 'Variable/TBD' : '$' + (d.amount || 0).toLocaleString();
                    const fundClass = `fund-badge ${d.fund_type || 'state'}`;
                    
                    return `
                        <tr>
                            <td>${d.source || '‚Äî'}</td>
                            <td>${d.destination || '‚Äî'}</td>
                            <td class="${amountClass}">${amountText}</td>
                            <td><span class="${fundClass}">${d.fund_type || 'state'}</span></td>
                            <td>${d.fiscal_year || '‚Äî'}</td>
                        </tr>
                    `;
                }).join('');
        }
        
        function renderAuthorityList(authorities) {
            const container = document.getElementById('authority-list');
            container.innerHTML = authorities.map(a => {
                const d = a.data || {};
                const governs = Array.isArray(d.governs) ? d.governs.slice(0, 3).join('; ') : '';
                
                return `
                    <div class="authority-item">
                        <div class="citation">${d.citation || a.id}</div>
                        <div class="body">Administered by: ${d.administering_body || 'Unknown'}</div>
                        ${governs ? `<div class="governs">Governs: ${governs}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function renderValidationList(validations) {
            const container = document.getElementById('validation-list');
            
            if (validations.length === 0) {
                container.innerHTML = '<p style="color:#666;">No audit findings loaded.</p>';
                return;
            }
            
            container.innerHTML = validations.map(v => {
                const d = v.data || {};
                const status = d.alignment_status || 'unknown';
                const statusColor = {
                    'captured': '#2e7d32',
                    'open': '#c62828',
                    'mixed': '#f57c00'
                }[status] || '#666';
                
                return `
                    <div class="authority-item" style="border-color: ${statusColor};">
                        <div class="citation">${v.id}</div>
                        <div class="body">Validating Entity: ${d.validating_entity || 'Unknown'}</div>
                        <div class="governs" style="color: ${statusColor}; font-weight:600;">
                            Status: ${status.toUpperCase()}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function setupTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.tab).classList.add('active');
                });
            });
        }
        
        // Initialize
        loadData();
    </script>
</body>
</html>
