<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artifact Graph ‚Äî Operation NAMI Clearlane</title>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            background: #16213e;
            padding: 12px 20px;
            border-bottom: 1px solid #0f3460;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 {
            font-size: 1.2rem;
            font-weight: 500;
            color: #e94560;
        }
        .stats {
            display: flex;
            gap: 20px;
            font-size: 0.85rem;
            color: #888;
        }
        .stats span { color: #4ecca3; font-weight: 600; }
        #controls {
            background: #16213e;
            padding: 10px 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 1px solid #0f3460;
        }
        #controls label {
            font-size: 0.8rem;
            color: #aaa;
        }
        #controls input[type="checkbox"] {
            margin-right: 5px;
        }
        #search {
            padding: 6px 12px;
            border: 1px solid #0f3460;
            border-radius: 4px;
            background: #1a1a2e;
            color: #eee;
            width: 250px;
        }
        #search:focus {
            outline: none;
            border-color: #4ecca3;
        }
        .legend {
            display: flex;
            gap: 15px;
            font-size: 0.75rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        #graph-container {
            flex: 1;
            position: relative;
            min-height: 500px;
            overflow: hidden;
        }
        #graph {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
        }
        #info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 350px;
            max-height: calc(100% - 20px);
            background: rgba(22, 33, 62, 0.95);
            border: 1px solid #0f3460;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            display: none;
        }
        #info-panel.visible { display: block; }
        #info-panel h3 {
            color: #e94560;
            font-size: 0.9rem;
            margin-bottom: 10px;
            word-break: break-all;
        }
        #info-panel .field {
            margin-bottom: 8px;
            font-size: 0.8rem;
        }
        #info-panel .field-label {
            color: #888;
            display: block;
            margin-bottom: 2px;
        }
        #info-panel .field-value {
            color: #4ecca3;
        }
        #info-panel .links-list {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #0f3460;
        }
        #info-panel .link-item {
            font-size: 0.75rem;
            padding: 4px 0;
            border-bottom: 1px solid #0f346033;
            cursor: pointer;
        }
        #info-panel .link-item:hover {
            color: #e94560;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 1.2rem;
        }
        .close-btn:hover { color: #e94560; }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #4ecca3;
        }
    </style>
</head>
<body>
    <header>
        <h1>üìä Artifact Linkage Graph ‚Äî Operation NAMI Clearlane</h1>
        <div class="stats">
            <div>Nodes: <span id="node-count">‚Äî</span></div>
            <div>Edges: <span id="edge-count">‚Äî</span></div>
            <div>Orphans: <span id="orphan-count">‚Äî</span></div>
        </div>
    </header>
    
    <div id="controls">
        <input type="text" id="search" placeholder="Search artifacts...">
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-dot" style="background: #e94560;"></div>
                <label><input type="checkbox" class="cat-filter" data-cat="authority_reference" checked> authority_reference</label>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #4ecca3;"></div>
                <label><input type="checkbox" class="cat-filter" data-cat="money_flow" checked> money_flow</label>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #f39c12;"></div>
                <label><input type="checkbox" class="cat-filter" data-cat="evidence_item" checked> evidence_item</label>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #9b59b6;"></div>
                <label><input type="checkbox" class="cat-filter" data-cat="field_validation" checked> field_validation</label>
            </div>
        </div>
        
        <label><input type="checkbox" id="hide-orphans"> Hide orphans</label>
        <label><input type="checkbox" id="show-labels"> Show labels</label>
        <label>Min links: <input type="range" id="min-links" min="0" max="20" value="5" style="width:80px"><span id="min-links-val">5</span></label>
    </div>
    
    <div id="graph-container">
        <div id="loading">Loading graph data...</div>
        <div id="graph"></div>
        <div id="info-panel">
            <button class="close-btn" onclick="closePanel()">√ó</button>
            <h3 id="panel-title"></h3>
            <div id="panel-content"></div>
        </div>
    </div>

    <script>
        const COLORS = {
            authority_reference: '#e94560',
            money_flow: '#4ecca3',
            evidence_item: '#f39c12',
            field_validation: '#9b59b6'
        };

        let network = null;
        let allNodes = [];
        let allEdges = [];
        let graphData = null;

        async function loadGraph() {
            try {
                const response = await fetch('artifacts_graph.json');
                graphData = await response.json();
                
                document.getElementById('node-count').textContent = graphData.metadata.total_nodes;
                document.getElementById('edge-count').textContent = graphData.metadata.total_edges;
                document.getElementById('orphan-count').textContent = graphData.metadata.orphan_count;
                
                buildGraph(graphData);
                document.getElementById('loading').style.display = 'none';
            } catch (err) {
                document.getElementById('loading').textContent = 'Error loading graph: ' + err.message;
            }
        }

        function buildGraph(data) {
            allNodes = data.nodes.map(n => ({
                id: n.id,
                label: n.label,
                title: n.id + ' (' + n.link_count + ' links)',
                color: {
                    background: COLORS[n.category] || '#666',
                    border: COLORS[n.category] || '#666',
                    highlight: { background: '#fff', border: COLORS[n.category] || '#666' }
                },
                category: n.category,
                link_count: n.link_count,
                is_orphan: n.is_orphan,
                size: Math.max(8, Math.min(50, 8 + n.link_count * 3)),
                font: { color: '#eee', size: 10 }
            }));

            allEdges = data.edges.map((e, i) => ({
                id: i,
                from: e.source,
                to: e.target,
                title: e.type,
                color: { color: '#445566', highlight: '#4ecca3' },
                arrows: 'to',
                smooth: { type: 'continuous' }
            }));

            renderGraph();
        }

        function renderGraph() {
            const filters = getFilters();
            const showLabels = document.getElementById('show-labels').checked;
            
            const visibleNodes = allNodes.filter(n => {
                if (!filters.categories.includes(n.category)) return false;
                if (filters.hideOrphans && n.is_orphan) return false;
                if (n.link_count < filters.minLinks) return false;
                if (filters.search && !n.id.toLowerCase().includes(filters.search.toLowerCase())) return false;
                return true;
            }).map(n => ({
                ...n,
                label: showLabels ? n.label : ''
            }));

            const visibleNodeIds = new Set(visibleNodes.map(n => n.id));
            const visibleEdges = allEdges.filter(e => 
                visibleNodeIds.has(e.from) && visibleNodeIds.has(e.to)
            );
            
            document.getElementById('node-count').textContent = visibleNodes.length + ' / ' + allNodes.length;
            document.getElementById('edge-count').textContent = visibleEdges.length + ' / ' + allEdges.length;

            const container = document.getElementById('graph');
            const options = {
                nodes: {
                    shape: 'dot',
                    scaling: { min: 10, max: 40 }
                },
                edges: {
                    width: 1,
                    selectionWidth: 2
                },
                layout: {
                    improvedLayout: false,
                    randomSeed: 42
                },
                physics: {
                    solver: 'forceAtlas2Based',
                    forceAtlas2Based: {
                        gravitationalConstant: -30,
                        centralGravity: 0.015,
                        springLength: 80,
                        springConstant: 0.1,
                        damping: 0.5
                    },
                    stabilization: { iterations: 50, fit: true },
                    maxVelocity: 30
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 100
                }
            };

            network = new vis.Network(container, {
                nodes: new vis.DataSet(visibleNodes),
                edges: new vis.DataSet(visibleEdges)
            }, options);

            network.on('click', function(params) {
                if (params.nodes.length > 0) {
                    showNodeInfo(params.nodes[0]);
                }
            });
        }

        function getFilters() {
            const categories = [];
            document.querySelectorAll('.cat-filter:checked').forEach(cb => {
                categories.push(cb.dataset.cat);
            });
            return {
                categories,
                hideOrphans: document.getElementById('hide-orphans').checked,
                minLinks: parseInt(document.getElementById('min-links').value) || 0,
                search: document.getElementById('search').value
            };
        }

        function showNodeInfo(nodeId) {
            const node = allNodes.find(n => n.id === nodeId);
            if (!node) return;

            const panel = document.getElementById('info-panel');
            document.getElementById('panel-title').textContent = node.id;

            // Find connected nodes
            const connectedEdges = allEdges.filter(e => e.from === nodeId || e.to === nodeId);
            const connections = connectedEdges.map(e => ({
                target: e.from === nodeId ? e.to : e.from,
                type: e.title,
                direction: e.from === nodeId ? '‚Üí' : '‚Üê'
            }));

            let html = `
                <div class="field">
                    <span class="field-label">Category</span>
                    <span class="field-value">${node.category}</span>
                </div>
                <div class="field">
                    <span class="field-label">Links</span>
                    <span class="field-value">${node.link_count}</span>
                </div>
            `;

            if (connections.length > 0) {
                html += `<div class="links-list"><strong>Connections (${connections.length}):</strong>`;
                connections.forEach(c => {
                    html += `<div class="link-item" onclick="focusNode('${c.target}')">${c.direction} ${c.type} ${c.target}</div>`;
                });
                html += '</div>';
            }

            document.getElementById('panel-content').innerHTML = html;
            panel.classList.add('visible');
        }

        function focusNode(nodeId) {
            network.selectNodes([nodeId]);
            network.focus(nodeId, { scale: 1.5, animation: true });
            showNodeInfo(nodeId);
        }

        function closePanel() {
            document.getElementById('info-panel').classList.remove('visible');
        }

        // Event listeners
        document.querySelectorAll('.cat-filter').forEach(cb => {
            cb.addEventListener('change', renderGraph);
        });
        document.getElementById('hide-orphans').addEventListener('change', renderGraph);
        document.getElementById('show-labels').addEventListener('change', renderGraph);
        document.getElementById('min-links').addEventListener('input', function() {
            document.getElementById('min-links-val').textContent = this.value;
            renderGraph();
        });
        document.getElementById('search').addEventListener('input', debounce(renderGraph, 300));

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Load on start
        loadGraph();
    </script>
</body>
</html>
